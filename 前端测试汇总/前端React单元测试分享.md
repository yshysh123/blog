# å‰ç«¯ React å•å…ƒæµ‹è¯•

## å‰è¨€

é•¿æœŸä»¥æ¥ï¼Œå‰ç«¯å¼€å‘çš„å•å…ƒæµ‹è¯•å¹¶ä¸æ˜¯åœ¨å‰ç«¯çš„å¼€å‘è¿‡ç¨‹ä¸­æ‰€å¿…é¡»çš„ï¼Œä¹Ÿä¸æ˜¯æ¯ä¸ªå‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆæ‰€æ³¨æ„å’Œé‡è§†çš„ï¼Œ
ç”šè‡³æ‰©å¤§åˆ°è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­å•å…ƒæµ‹è¯•è¿™ä¸€ç¯ä¹Ÿä¸æ˜¯åœ¨ç« ç¨‹ä¸Šæœ‰ä¹¦é¢è§„å®šæ‰€è¦æ±‚çš„ã€‚æ›¾ç»çš„æˆ‘ä¹Ÿé—®è¿‡è®¸å¤šæ¬¡è‡ªå·±ä»¥åŠèº«è¾¹çš„å‰ç«¯å·¥ç¨‹å¸ˆã€‚
ä¸ºä»€ä¹ˆå‰ç«¯è¦å†™å•å…ƒæµ‹è¯•ï¼Ÿå‰ç«¯çš„å•å…ƒæµ‹è¯•å’Œæµ‹è¯•å·¥ç¨‹å¸ˆçš„æµ‹è¯•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒèŠ±è´¹å¤§é‡æ—¶é—´ï¼ˆç”šè‡³å¯èƒ½å¤§äº 50%ï¼‰çš„ä¹‹é—´å»å†™å•å…ƒæµ‹è¯•å€¼ä¸å€¼å¾—ï¼Ÿ

### ä¸ºä»€ä¹ˆè¦è¿›è¡Œæµ‹è¯•ï¼Ÿï¼Ÿ

1. æµ‹è¯•å¯ä»¥ç¡®ä¿å¾—åˆ°é¢„æœŸçš„ç»“æœ
2. ä½œä¸ºç°æœ‰ä»£ç è¡Œä¸ºçš„æè¿°
3. ä¿ƒä½¿å¼€å‘è€…å†™å¯æµ‹è¯•çš„ä»£ç ï¼Œä¸€èˆ¬å¯æµ‹è¯•çš„ä»£ç å¯è¯»æ€§ä¹Ÿä¼šé«˜ä¸€ç‚¹
4. å¦‚æœä¾èµ–çš„ç»„ä»¶æœ‰ä¿®æ”¹ï¼Œå—å½±å“çš„ç»„ä»¶èƒ½åœ¨æµ‹è¯•ä¸­å‘ç°é”™è¯¯

### æµ‹è¯•ç±»å‹

- å•å…ƒæµ‹è¯•ï¼šæŒ‡çš„æ˜¯ä»¥åŸä»¶çš„å•å…ƒä¸ºå•ä½ï¼Œå¯¹è½¯ä»¶è¿›è¡Œæµ‹è¯•ã€‚å•å…ƒå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ¨¡å—æˆ–ä¸€ä¸ªç»„ä»¶ï¼ŒåŸºæœ¬ç‰¹å¾å°±æ˜¯åªè¦è¾“å…¥ä¸å˜ï¼Œå¿…å®šè¿”å›åŒæ ·çš„è¾“å‡ºã€‚ä¸€ä¸ªè½¯ä»¶è¶Šå®¹æ˜“äº›å•å…ƒæµ‹è¯•ï¼Œå°±è¡¨æ˜å®ƒçš„æ¨¡å—åŒ–ç»“æ„è¶Šå¥½ï¼Œç»™æ¨¡å—ä¹‹é—´çš„è€¦åˆè¶Šå¼±ã€‚React çš„ç»„ä»¶åŒ–å’Œå‡½æ•°å¼ç¼–ç¨‹ï¼Œå¤©ç”Ÿé€‚åˆè¿›è¡Œå•å…ƒæµ‹è¯•
- åŠŸèƒ½æµ‹è¯•ï¼šç›¸å½“äºæ˜¯é»‘ç›’æµ‹è¯•ï¼Œæµ‹è¯•è€…ä¸äº†è§£ç¨‹åºçš„å†…éƒ¨æƒ…å†µï¼Œä¸éœ€è¦å…·å¤‡ç¼–ç¨‹è¯­è¨€çš„ä¸“é—¨çŸ¥è¯†ï¼ŒåªçŸ¥é“ç¨‹åºçš„è¾“å…¥ã€è¾“å‡ºå’ŒåŠŸèƒ½ï¼Œä»ç”¨æˆ·çš„è§’åº¦é’ˆå¯¹è½¯ä»¶ç•Œé¢ã€åŠŸèƒ½å’Œå¤–éƒ¨ç»“æ„è¿›è¡Œæµ‹è¯•ï¼Œä¸è€ƒè™‘å†…éƒ¨çš„é€»è¾‘
- é›†æˆæµ‹è¯•ï¼šåœ¨å•å…ƒæµ‹è¯•çš„åŸºç¡€ä¸Šï¼Œå°†æ‰€æœ‰æ¨¡å—æŒ‰ç…§è®¾è®¡è¦æ±‚ç»„è£…æˆå­ç³»ç»Ÿæˆ–è€…ç³»ç»Ÿï¼Œè¿›è¡Œæµ‹è¯•
- å†’çƒŸæµ‹è¯•ï¼šåœ¨æ­£å¼å…¨é¢çš„æµ‹è¯•ä¹‹å‰ï¼Œå¯¹ä¸»è¦åŠŸèƒ½è¿›è¡Œçš„ä¸æµ‹è¯•ï¼Œç¡®è®¤ä¸»è¦åŠŸèƒ½æ˜¯å¦æ»¡è¶³éœ€è¦ï¼Œè½¯ä»¶æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œ

### å¼€å‘æ¨¡å¼

- TDD: æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œè‹±æ–‡ä¸º Testing Driven Developmentï¼Œå¼ºè°ƒçš„æ˜¯ä¸€ç§å¼€å‘æ–¹å¼ï¼Œä»¥æµ‹è¯•æ¥é©±åŠ¨æ•´ä¸ªé¡¹ç›®ï¼Œå³å…ˆæ ¹æ®æ¥å£å®Œæˆæµ‹è¯•ç¼–å†™ï¼Œç„¶ååœ¨å®ŒæˆåŠŸèƒ½æ˜¯è¦ä¸æ–­é€šè¿‡æµ‹è¯•ï¼Œæœ€ç»ˆç›®çš„æ˜¯é€šè¿‡æ‰€æœ‰æµ‹è¯•
- BDD: è¡Œä¸ºé©±åŠ¨æµ‹è¯•ï¼Œè‹±æ–‡ä¸º Behavior Driven Developmentï¼Œå¼ºè°ƒçš„æ˜¯å†™æµ‹è¯•çš„é£æ ¼ï¼Œå³æµ‹è¯•è¦å†™çš„åƒè‡ªç„¶è¯­è¨€ï¼Œè®©é¡¹ç›®çš„å„ä¸ªæˆå‘˜ç”šè‡³äº§å“éƒ½èƒ½çœ‹æ‡‚æµ‹è¯•ï¼Œç”šè‡³ç¼–å†™æµ‹è¯•

TDD å’Œ BDD æœ‰å„è‡ªçš„ä½¿ç”¨åœºæ™¯ï¼ŒBDD ä¸€èˆ¬åå‘äºç³»ç»ŸåŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘çš„è‡ªåŠ¨åŒ–æµ‹è¯•è®¾è®¡ï¼›è€Œ TDD åœ¨å¿«é€Ÿå¼€å‘å¹¶æµ‹è¯•åŠŸèƒ½æ¨¡å—çš„è¿‡ç¨‹ä¸­åˆ™æ›´åŠ é«˜æ•ˆï¼Œä»¥å¿«é€Ÿå®Œæˆå¼€å‘ä¸ºç›®çš„ã€‚

## å‡†å¤‡: å‰ç«¯ç¯å¢ƒ

å¸¸è§ç¯å¢ƒéƒ¨ç½²æ–¹æ³•ï¼ŒåŸºæœ¬éƒ½æ˜¯åœ¨ nodejs å®˜ç½‘ä¸‹è½½ exeï¼Œmsi æ–‡ä»¶åŒå‡»å®‰è£…åç›´æ¥å¯ç”¨ã€‚
nodejs æ˜¯ä¸€é—¨æ›´æ–°å¾ˆå¿«çš„è¯­è¨€ï¼Œæˆ‘ä»¬å¸¸å¸¸è¦ç»´æŠ¤è€é¡¹ç›®ï¼Œè€é¡¹ç›®ä¾èµ–æŸä¸ªè¾ƒæ—©çš„ nodejs ç‰ˆæœ¬ï¼Œéšä¾¿å‡çº§ä¼šç”Ÿæˆè«åå…¶å¦™çš„é”™è¯¯ã€‚
è€Œ nodejs çš„ç”Ÿæ€ç¯å¢ƒæ˜¯æ€»åœ¨ä¸æ–­å‘å‰æ¨è¿›çš„ï¼Œå¾ˆå¤šå·¥å…·ï¼Œç¬¬ä¸‰æ–¹åŒ…éƒ½åœ¨å‰è¿›ï¼Œèˆå¼ƒæ—§ç¯å¢ƒã€‚
å¾ˆå¤šæ—¶å€™å¦‚æœç¯å¢ƒä¸å‡çº§ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å®‰è£…å¾ˆå¤šè€ç‰ˆæœ¬å·¥å…·ï¼Œè€Œä¸”è¿æ–‡æ¡£éƒ½æŸ¥é˜…éƒ½ä¼šæ··ä¹±ï¼Œæˆ‘ä»¬ç¨‹åºå‘˜ä¹Ÿæœ‰éœ€è¦ä¿æŒæœ€æ–°çš„çŸ¥è¯†æ ˆçš„éœ€æ±‚ã€‚
æ­¤å¤„æ¨èä½¿ç”¨ç¼–ç¨‹è¯­è¨€ç‰ˆæœ¬åˆ‡æ¢å·¥å…· ğŸ€ï¼Œnodejs çš„å°±æ˜¯[nvm](https://github.com/creationix/nvm)ï¼Œ
å…¨ç§° Node Version Managerï¼Œå®˜ç½‘æœ‰å¤šç³»ç»Ÿå®‰è£…æ–¹å¼ã€‚

## å•å…ƒæµ‹è¯•å·¥å…·

è¯´èµ·å•å…ƒæµ‹è¯•ï¼Œå¸‚é¢ä¸Šçš„å•å…ƒæµ‹è¯•å·¥å…·å½¢å½¢è‰²è‰²ï¼Œäº”èŠ±å…«é—¨ã€‚æœ€å¸¸ä½¿ç”¨çš„å·¥å…·ä¸º:Jest Mocha Jasmine

- ğŸ›  å·¥å…·[Jest](https://www.npmjs.com/package/eslint)
  å®‰è£…

  ```bash
  yarn add jest
  ```

  - facebook ååº„
  - åŸºäº Jasmine è‡³ä»Šå·²ç»åšäº†å¤§é‡ä¿®æ”¹æ·»åŠ äº†å¾ˆå¤šç‰¹æ€§
  - å¼€ç®±å³ç”¨é…ç½®å°‘ï¼ŒAPI ç®€å•
  - æ”¯æŒæ–­è¨€å’Œä»¿çœŸ
  - æ”¯æŒå¿«ç…§æµ‹è¯•
  - åœ¨éš”ç¦»ç¯å¢ƒä¸‹æµ‹è¯•
  - äº’åŠ¨æ¨¡å¼é€‰æ‹©è¦æµ‹è¯•çš„æ¨¡å—
  - ä¼˜é›…çš„æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šï¼ŒåŸºäº Istanbul
  - æ™ºèƒ½å¹¶è¡Œæµ‹è¯•(å‚è€ƒ)
  - è¾ƒæ–°ï¼Œç¤¾åŒºä¸ååˆ†æˆç†Ÿ
  - å…¨å±€ç¯å¢ƒï¼Œæ¯”å¦‚ describe ä¸éœ€è¦å¼•å…¥ç›´æ¥ç”¨
  - è¾ƒå¤šç”¨äº React é¡¹ç›®(ä½†å¹¿æ³›æ”¯æŒå„ç§é¡¹ç›®)

- ğŸ›  å·¥å…·[Mocha](https://mochajs.org/)
  å®‰è£…

  ```bash
  yarn add mocha
  ```

  - çµæ´»(ä¸åŒ…æ‹¬æ–­è¨€å’Œä»¿çœŸï¼Œè‡ªå·±é€‰å¯¹åº”å·¥å…·)
  - æµè¡Œçš„é€‰æ‹©ï¼šchaiï¼Œsinon
  - ç¤¾åŒºæˆç†Ÿç”¨çš„äººå¤šï¼Œæµ‹è¯•å„ç§ä¸œè¥¿ç¤¾åŒºéƒ½æœ‰ç¤ºä¾‹
  - éœ€è¦è¾ƒå¤šé…ç½®
  - å¯ä»¥ä½¿ç”¨å¿«ç…§æµ‹è¯•ï¼Œä½†ä¾ç„¶éœ€è¦é¢å¤–é…ç½®

ä¸ªäººæ¨èä½¿ç”¨ jest è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚ç†ç”±å¦‚ä¸‹ï¼š

- jest ä¸ babel å¯¹ es6 çš„è½¬ç é›†æˆè‰¯å¥½ã€‚
- jest çš„ api æ–‡æ¡£å®Œæ•´ä¸” api è®¾è®¡è‰¯å¥½ã€‚
- jest å¯¹å¼‚æ­¥ä»£ç æµ‹è¯•å†…ç½®æ”¯æŒå®Œå–„ã€‚
- jest å†…ç½®å®Œå–„çš„ mock ä¸ stub å·¥å…·ã€‚
- jest è¿è¡Œå¦‚é£ã€‚
- jest å¯è‡ªè°ƒç”¨ istanbulï¼Œæ— ç—›ç”Ÿæˆè¦†ç›–ç‡ç»Ÿè®¡æ–‡æ¡£ã€‚
- jest ä½¿ç”¨çº¦å®šå¤§äºé…ç½®çš„åŸåˆ™ï¼Œéœ€é…ç½®é¡¹è¾ƒå°‘ï¼Œä¸”åŒæ—¶å…¼é¡¾å®šåˆ¶éœ€æ±‚ã€‚
- ä½¿ç”¨ jsdomï¼Œåœ¨ nodejs ç¯å¢ƒå¯æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒï¼Œä¸ jest é›†æˆåæµ‹è¯•å‰ç«¯çš„æµè§ˆå™¨ç¯å¢ƒä»£ç ã€‚
- jest æ–‡æ¡£ä¸°å¯Œä¸”æœ‰å¹¿æ³›çš„å¼€å‘è€…åŸºç¡€ã€‚

(Jest å¸¸ç”¨ API)[https://jestjs.io/docs/en/api.html]

- describe(name, fn)ï¼šæè¿°å—ï¼Œè®²ä¸€ç»„åŠŸèƒ½ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹ç»„åˆåœ¨ä¸€èµ·
- it(name, fn, timeout)ï¼šåˆ«å testï¼Œç”¨æ¥æ”¾æµ‹è¯•ç”¨ä¾‹
- afterAll(fn, timeout)ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹è·‘å®Œä»¥åæ‰§è¡Œçš„æ–¹æ³•
- beforeAll(fn, timeout)ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•
- afterEach(fn)ï¼šåœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œåæ‰§è¡Œçš„æ–¹æ³•
- beforeEach(fn)ï¼šåœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œä¹‹å‰éœ€è¦æ‰§è¡Œçš„æ–¹æ³•

Enzyme

Enzyme æ˜¯ Airbnb å¼€æºçš„ React æµ‹è¯•å·¥å…·åº“åº“ï¼Œå®ƒåŠŸèƒ½è¿‡å¯¹å®˜æ–¹çš„æµ‹è¯•å·¥å…·åº“ ReactTestUtils çš„äºŒæ¬¡å°è£…ï¼Œæä¾›äº†ä¸€å¥—ç®€æ´å¼ºå¤§çš„ APIã€‚
å®ç°äº† jQuery é£æ ¼çš„æ–¹å¼è¿›è¡Œ DOM å¤„ç†ï¼Œå¼€å‘ä½“éªŒååˆ†å‹å¥½ã€‚åœ¨å¼€æºç¤¾åŒºæœ‰è¶…é«˜äººæ°”ï¼ŒåŒæ—¶ä¹Ÿè·å¾—äº† React å®˜æ–¹çš„æ¨èã€‚

ä¸‰ç§æ¸²æŸ“æ–¹æ³•

- shallowï¼šæµ…æ¸²æŸ“ï¼Œæ˜¯å¯¹å®˜æ–¹çš„ Shallow Renderer çš„å°è£…ã€‚å°†ç»„ä»¶æ¸²æŸ“æˆè™šæ‹Ÿ DOM å¯¹è±¡ï¼Œåªä¼šæ¸²æŸ“ç¬¬ä¸€å±‚ï¼Œå­ç»„ä»¶å°†ä¸ä¼šè¢«æ¸²æŸ“å‡ºæ¥ï¼Œä½¿å¾—æ•ˆç‡éå¸¸é«˜ã€‚ä¸éœ€è¦ DOM ç¯å¢ƒï¼Œ å¹¶å¯ä»¥ä½¿ç”¨ jQuery çš„æ–¹å¼è®¿é—®ç»„ä»¶çš„ä¿¡æ¯
- renderï¼šé™æ€æ¸²æŸ“ï¼Œå®ƒå°† React ç»„ä»¶æ¸²æŸ“æˆé™æ€çš„ HTML å­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨ Cheerio è¿™ä¸ªåº“è§£æè¿™æ®µå­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›ä¸€ä¸ª Cheerio çš„å®ä¾‹å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥åˆ†æç»„ä»¶çš„ html ç»“æ„
- mountï¼šå®Œå…¨æ¸²æŸ“ï¼Œå®ƒå°†ç»„ä»¶æ¸²æŸ“åŠ è½½æˆä¸€ä¸ªçœŸå®çš„ DOM èŠ‚ç‚¹ï¼Œç”¨æ¥æµ‹è¯• DOM API çš„äº¤äº’å’Œç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚ç”¨åˆ°äº† jsdom æ¥æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒ

æµ‹è¯•çš„æ¸è¿›æ€§ï¼š

1. å‡½æ•°å•å…ƒæµ‹è¯•
2. ç»„ä»¶å•å…ƒæµ‹è¯•
3. é¡µé¢å•å…ƒæµ‹è¯•
4. E2E æµ‹è¯•

## å‡½æ•°å¼å•å…ƒæµ‹è¯•

### æµ‹è¯•å‰é¡»çŸ¥

1. ä½¿ç”¨ Jest è¿›è¡Œå•å…ƒæµ‹è¯•å¿…é¡»ä¿è¯å‡½æ•°å¼çº¯å‡½æ•°ã€‚å³å‡½æ•°æœ‰å…¥å‚å¹¶ä»¥ return ç»“å°¾ã€‚
2. å‡½æ•°å°½é‡ä¸è¦ä¾èµ–å¤–éƒ¨å˜é‡ã€‚
3. react å‡½æ•°ï¼ˆè¿”å›å€¼ä¸º JSXï¼‰ä¸å±äºè¯¥æµ‹è¯•èŒƒå›´
4. jest é…ç½®ï¼šåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º jest.config.jsã€‚

### æµ‹è¯•æ­¥éª¤

1. å†™ä¸€ä¸ªçº¯å‡½æ•°

```javascript
  import moment from 'moment'
  type TDate = string | moment.Moment
  const convert = (date: TDate): moment.Moment => {
    if (typeof date === 'string') {
      return moment(date)
    }
    return date
  }
  export default {
    uponDay: (date: TDate) => date && convert(date).format('YYYY-MM-DD'),
    uponSeconds: (date: TDate) =>
      date && convert(date).format('YYYY-MM-DD HH:mm:ss'),

```

2. åœ¨**test**æ–‡ä»¶å¤¹ä¸‹å»ºä¸€ä¸ªæ–‡ä»¶ fn.test.js

3. è¿›è¡Œå•å…ƒæµ‹è¯•

```javascript
import dateFormater from 'tool/dateFormater'
import moment from 'moment'

const { uponDay, uponSeconds } = dateFormater

describe('æµ‹è¯•dateFormater', () => {
  it('æµ‹è¯•æ ¼å¼åŒ–åˆ°å¤©ï¼Œæ— æ—¶åˆ†ç§’', () => {
    expect(uponDay(moment('2018-09-20'))).toBe('2018-09-20')
  })

  it('æµ‹è¯•æ ¼å¼åŒ–åˆ°å¤©ï¼Œæ— æ—¶åˆ†ç§’ï¼Œæ—¥æœŸä¸ºå­—ç¬¦ä¸²ç±»å‹', () => {
    expect(uponDay('2018-09-20')).toBe('2018-09-20')
  })

  it('æµ‹è¯•æ ¼å¼åŒ–åˆ°å¤©ï¼Œå¸¦æ—¶åˆ†ç§’', () => {
    expect(uponDay(moment('2018-09-20 08:08:00'))).toBe('2018-09-20')
  })

  it('æµ‹è¯•æ ¼å¼åŒ–åˆ°ç§’', () => {
    expect(uponSeconds(moment('2018-09-26T16:45:36.000+0000'))).toBe(
      '2018-09-27 00:45:36',
    )
  })

  it('æµ‹è¯•æ ¼å¼åŒ–åˆ°ç§’ï¼Œæ—¥æœŸä¸ºå­—ç¬¦ä¸²ç±»å‹', () => {
    expect(uponSeconds('2018-09-26T16:45:36.000+0000')).toBe(
      '2018-09-27 00:45:36',
    )
  })
})
```

## ç»„ä»¶å•å…ƒæµ‹è¯•

### æµ‹è¯•å‰é¡»çŸ¥

1. ä½¿ç”¨ Jest è¿›è¡Œç»„ä»¶æµ‹è¯•éœ€è¦æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒï¼Œç›®å‰ä¸ react é…åˆè¾ƒå¥½çš„æ˜¯ enzyme åŠ jsdomã€‚
2. ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹åªåšä¸€ä»¶äº‹ï¼Œæ‰€ä»¥å°½å¯èƒ½å°†ç»„ä»¶æ‹†åˆ†ä¸ºæœ€å°å•å…ƒã€‚
3. æ¨¡æ‹Ÿæ•°æ®åŠæ¥å£ä½¿ç”¨ fetch-mock
4. åœ¨æµ‹è¯•ä¹‹å‰æ‰§è¡Œ steup å‡½æ•°å°†æ‰€æœ‰ç¯å¢ƒæ¨¡æ‹Ÿå¥½ï¼Œåœ¨æµ‹è¯•ä¸­ç›´æ¥ä½¿ç”¨å³å¯

### æµ‹è¯•ç»„ä»¶å†…å®¹

React ç»„ä»¶åˆ†ä¸ºå››ç§ï¼š

1. å±•ç¤ºå‹ä¸šåŠ¡ç»„ä»¶
2. å®¹å™¨å‹ä¸šåŠ¡ç»„ä»¶
3. é€šç”¨ UI ç»„ä»¶
4. ä¸šåŠ¡ã€åŠŸèƒ½å‹ç»„ä»¶

æµ‹è¯•çš„é‡ç‚¹ä¸»è¦æ”¾åœ¨ä¸šåŠ¡ã€åŠŸèƒ½å‹ç»„ä»¶

ä¸šåŠ¡ã€åŠŸèƒ½å‹ç»„ä»¶å¿…é¡»æµ‹è¯•çš„ä¸‰éƒ¨åˆ†ï¼š

1. Props ä¼ å…¥ï¼›
2. ç»„ä»¶åˆ†æ”¯æ¸²æŸ“é€»è¾‘ï¼›
3. äº‹ä»¶è°ƒç”¨å’Œå‚æ•°ä¼ é€’ã€‚

### æµ‹è¯•æ­¥éª¤

å°±æ‹¿ä¸€ä¸ªç®€å•çš„æƒé™é«˜é˜¶ç»„ä»¶åšä¾‹å­ï¼š

```javascript
import React from 'react'
import { Provider } from 'mobx-react'
import { mount } from 'enzyme'
import Permission from 'component/Permission'
import permissionStore from 'store/permission'

const TestPermission = () => (
  <Provider store={{ permissionStore }}>
    <Permission resource="ok">
      <span>hasPermission</span>
    </Permission>
  </Provider>
)

describe('component/Permission', () => {
  it('æµ‹è¯•æ— æƒé™', () => {
    const app = mount(<TestPermission />)
    expect(permissionStore.has('ok')).toBe(false)
    expect(app.text()).toBe(null)
  })

  it('æµ‹è¯•æœ‰æƒé™', () => {
    permissionStore.data.add('ok')
    const app = mount(<TestPermission />)
    expect(permissionStore.has('ok')).toBe(true)
    expect(app.text()).toBe('hasPermission')
  })
})
```

## é¡µé¢çº§åˆ«å•å…ƒæµ‹è¯•

é€šå¸¸é¡µé¢çº§åˆ«çš„å•å…ƒæµ‹è¯•æ˜¯ä¸éœ€è¦å‰ç«¯æ¥åšçš„ã€‚é¡µé¢é€šå¸¸è¢«åˆ†å‰²æˆå¤šä¸ªå…¬ç”¨çš„ç»„ä»¶åŠ Storeï¼ˆMVVM ä¸‹ï¼‰ï¼Œæ•°æ®ä¸è¡¨ç°åˆ†ç¦»ï¼Œå³æ•°æ®å±‚å’Œé€šç”¨ç»„ä»¶å±‚æˆ‘ä»¬å·²ç»é€šè¿‡ä¸Šè¿° 2 ç§æ–¹å¼è¿›è¡Œè¿‡ç›¸åº”çš„å•å…ƒæµ‹è¯•äº†ã€‚é¡µé¢çº§åˆ«çš„æµ‹è¯•é€šå¸¸åªé’ˆå¯¹ç®€å•çš„æ–‡æ¡ˆåŠ CSS è¿›è¡Œæµ‹è¯•å°±å¤Ÿäº†ã€‚

ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å¯¹ä¸€ä¸ªé¡µé¢çš„è·Ÿç»„ä»¶è¿›è¡Œæµ‹è¯•ï¼š

```javascript
import React from 'react'
import { shallow } from 'enzyme'
import { Card } from 'antd'
import A from 'page/A'
import Operation from 'page/A/Operation'
import List from 'page/A/List'
import Search from 'page/A/Search'
import CardTitle from 'component/CardTitle'

describe('page/A', () => {
  it('æµ‹è¯•é¡µé¢å¯å®Œæ•´æ¸²æŸ“', () => {
    const app = shallow(<A />)
    expect(app.find(Card)).toHaveLength(1)
    expect(app.contains(<Operation />)).toBeTruthy()
    expect(app.contains(<List />)).toBeTruthy()

    // æµ‹è¯•å¯å®Œæ•´æ¸²æŸ“Card titleå±æ€§
    const title = app.find(Card).prop('title')
    expect(title.type).toEqual(CardTitle)
    expect(title.props.children.type).toEqual(Search)

    const app2 = shallow(<A showOperation={false} />)
    expect(app2.contains(<Operation />)).toBeFalsy()
  })
})
```

## E2E å•å…ƒæµ‹è¯•

é—®é¢˜ï¼Ÿï¼Ÿå¦‚ä½•ç¡®å®šç”¨æˆ·å¯ä»¥é¡ºåˆ©èµ°å®Œä¸€ä¸ªè´­ä¹°æµç¨‹å‘¢?

1. æ‰“å¼€ç½‘é¡µ
2. æµè§ˆå•†å“
3. åŠ å…¥è´­ç‰©è½¦
4. ä¸‹å•ç¡®è®¤
5. ä»˜æ¬¾

å•çº¯ä¾é äººåŠ›æ¥æµ‹è¯•å®Œæ•´åŠŸèƒ½éå¸¸è€—æ—¶è€—åŠ›, è¿™æ—¶å€™è‡ªåŠ¨åŒ–æµ‹è¯•å°±ä½“ç°ä»·å€¼äº†

è‡ªåŠ¨åŒ–æµ‹è¯•æ˜¯æŠŠäººçš„æµ‹è¯•è¡Œä¸ºè½¬åŒ–ä¸ºæœºå™¨æ‰§è¡Œçš„ç¨‹åº, å¯ä»¥æé«˜æ•ˆç‡, è§£æ”¾ç”Ÿäº§åŠ›, èŠ‚çœäººåŠ›æˆæœ¬å’Œæ—¶é—´æˆæœ¬, é™ä½äººç±»æ˜“å‡ºé”™çš„é£é™©

ç°ä»£æ¯”è¾ƒæµè¡Œçš„ e2e æµ‹è¯•æ¡†æ¶æœ‰

- Nightwatch
- TestCafe
- Protractor
- WebdriverIO
- Cypress
- Jest puppeteer

### æµ‹è¯•å‰é¡»çŸ¥

1. é€šå¸¸ E2E æµ‹è¯•æ˜¯æˆ‘ä»¬æ­£å¸¸å¼€å‘å·²ç»å®Œæˆï¼Œæœ€å¥½æœ‰å®Œæ•´çš„æµ‹è¯•ç¯å¢ƒï¼ˆå¼€å‘ã€ç”Ÿäº§ï¼‰ã€‚
2. E2E æµ‹è¯•éœ€è¦æˆ‘ä»¬é˜Ÿæ•´ä¸ªä¸šåŠ¡é€»è¾‘éå¸¸ç†Ÿç»ƒï¼Œå³å¤šé¡µé¢ä¹‹é—´çš„äº¤äº’ç”šè‡³æ•´ä¸ªé¡¹ç›®æµç¨‹ã€‚

ä¸‹é¢ä»‹ç»æˆ‘ä¸»è¦ä½¿ç”¨çš„ 2 ç§ E2E æµ‹è¯•å·¥å…· Nightwatch åŠ Jest puppeteer

Nightwatch

```javascript
module.exports = {
  'test notFound page': browser => {
    browser
      .url('http://localhost:8080/xxxx')
      .maximizeWindow()
      .useXpath()
      .assert.containsText('//*[@id="app"]/div[3]/div[2]/h1', '404')
      .assert.containsText(
        '//*[@id="app"]/div[3]/div[2]/h2',
        'æŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨',
      )
      .pause(1000)
      .assert.urlContains('http://localhost:8080/xxxx')
      .click('//*[@id="app"]/div[3]/div[2]/div/button')
      .pause(1000)
      .assert.urlContains('http://localhost:8080/Home')
      .end()
  },
}
```

Jest puppeteer

```javascript
describe('goto page', () => {
  beforeAll(async () => {
    // page = await browser.newPage()
    await page.setViewport({
      width: 1920,
      height: 1080,
    })
  })

  it('go to user page', async () => {
    await page.goto(`${pageUrl}/user`)
    await page.waitForSelector('label[for="account"]')
    await page.waitForSelector('label[for="name"]')
    await page.waitForSelector('label[for="mail"]')
    await page.waitForSelector('label[for="mobile"]')
  })

  it('coverage', async () => {
    await Promise.all([
      page.coverage.startJSCoverage(),
      page.coverage.startCSSCoverage(),
    ])
    await page.goto(pageUrl)
    await page.hover('.ant-menu-root')
    await page.click('.ant-menu-item a[href="/user"]')
    // await jestPuppeteer.debug()
    const [jsCoverage, cssCoverage] = await Promise.all([
      page.coverage.stopJSCoverage(),
      page.coverage.stopCSSCoverage(),
    ])
    const coverage = [...jsCoverage, ...cssCoverage]
    let totalBytes = 0
    let usedBytes = 0
    coverage.forEach(entry => {
      totalBytes += entry.text.length
      entry.ranges.forEach(range => {
        usedBytes += range.end - range.start - 1
      })
    })
    log(`Bytes used: ${(usedBytes / totalBytes) * 100}%`)
  })
})
```

## å•å…ƒæµ‹è¯•å¸¸ç”¨é…ç½®

```javascript
{
  //è¦†ç›–ç‡ç»Ÿè®¡æ–‡ä»¶å¤¹åŠæ–‡ä»¶
  "collectCoverageFrom": [
    "src/component/**/*.{js,jsx,mjs}",
    "src/page/**/*.{js,jsx,mjs}",
    "src/store/**/*.{js,jsx,mjs}",
    "src/storeProp/**/*.{js,jsx,mjs}",
    "src/mixin/**/*.{js,jsx,mjs}",
    "src/tool/**/*.{js,jsx,mjs}"
  ],
  //å…¥å£æ–‡ä»¶
  "setupFiles": [
    "<rootDir>/jest/setup.js"
  ],
  //æµ‹è¯•ä»£ç æ–‡ä»¶
  "testMatch": [
    "<rootDir>/__test__/**/?(*.)(spec|test).{js,jsx,ts,tsx}"
  ],
  //æµ‹è¯•Setupä¹‹åæ‰§è¡Œçš„æ–‡ä»¶
  "setupTestFrameworkScriptFile": "<rootDir>/jest/afterSetup.js",
  //ç”Ÿæˆdomæ‰€éœ€çš„åº“
  "testEnvironment": "enzyme",
  //æµ‹è¯•Url
  "testURL": "http://localhost",
  //è½¬æ¢ ES6->5 ts åŠ css æ–‡ä»¶
  "transform": {
    "^.+\\.(js|jsx|mjs)$": "<rootDir>/node_modules/babel-7-jest",
    "^.+\\.tsx?$": "ts-jest",
    "^.+\\.(css|less)$": "<rootDir>/jest/cssTransform.js"
  },
  //ä¸è½¬æ¢çš„æ–‡ä»¶
  "transformIgnorePatterns": [
    "<rootDir>/node_modules/(?!lodash-es/).+(js|jsx|mjs)$"
  ],
  //åˆ«åï¼Œç±»ä¼¼äºalias
  "moduleNameMapper": {
    "^component/(.+)$": "<rootDir>/src/component/$1",
    "^tool/(.+)$": "<rootDir>/src/tool/$1",
    "^store/(.+)$": "<rootDir>/src/store/$1",
    "^page/(.+)$": "<rootDir>/src/page/$1",
    "^mixin/(.+)$": "<rootDir>/src/mixin/$1",
    "^storeProp/(.+)$": "<rootDir>/src/storeProp/$1",
    "^src/(.+)$": "<rootDir>/src/$1",
    "^locale/(.+)$": "<rootDir>/src/locale/$1",
    "^fixture/(.+)$": "<rootDir>/__test__/fixture/$1",
    "history/createBrowserHistory": "<rootDir>/node_modules/history/createMemoryHistory",
    "^.+\\.less$": "identity-obj-proxy"
  },
  //åç¼€ï¼Œç±»ä¼¼äºextensions
  "moduleFileExtensions": [
    "js",
    "json",
    "jsx",
    "ts",
    "tsx"
  ],
  //æµ‹è¯•å®Œæ¯•åæ¸…é™¤mocks
  "clearMocks": true,
  //Resets Mocks
  "restoreMocks": true
},
```

## è¦†ç›–ç‡

åœ¨å¦‚ä¸Š jest é…ç½®ä¹‹åï¼Œå½•å…¥éœ€è¦ç»Ÿè®¡è¦†ç›–ç‡çš„æ–‡ä»¶ï¼Œå³å¯ç»Ÿè®¡å•å…ƒæµ‹è¯•çš„è¦†ç›–ç‡ã€‚

å¯¹åº”çš„è¦†ç›–ç‡ç»Ÿè®¡å‘½ä»¤å¦‚ä¸‹ï¼š

```javascript
//vue
"coverage": "yarn run test:unit --coverage && node jest/openCoverage.js"
//react
"coverage": "npx jest --coverage && node jest/openCoverage.js"
```

## é›†æˆæµ‹è¯•

é›†æˆæµ‹è¯•éœ€è¦ä¸€äº›ç¬¬ä¸‰æ–¹å·¥å…·æ‰€é…åˆï¼Œä¾‹å¦‚ï¼šgitlab é’©å­ï¼Œgithub é’©å­ï¼Œdocker ç­‰ç­‰

ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®æäº¤ä»£ç çš„ä¹‹å‰è¿›è¡Œå•å…ƒæµ‹è¯•

```javascript
"gitHooks": {
  "pre-commit": "npx jest"
}
```
